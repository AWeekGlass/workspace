<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hengyu.cases.dao.CaseDAO">
	<!-- 根据案例分类查询列表 -->
	<select id="queryAllByCategoryId" resultType="CaseInfoVo">	
		SELECT * FROM (SELECT t1.id,t1.title,t1.content,t1.create_time,t1.top_time,t2.user_name AS ref_name FROM jyq_case t1 LEFT JOIN jyq_admin t2 ON t1.ref_id = t2.id
				<where>
					t1.top_time IS NOT NULL AND t1.is_draft = 0
					<if test="categoryId != null and categoryId != ''">
						AND t1.category_id = #{categoryId}
					</if>
					<if test="companyId != null and companyId != ''">
						AND t1.company_id = #{companyId}
					</if>
				</where>
				ORDER BY t1.top_time)t
		UNION ALL
		SELECT * FROM (SELECT t1.id,t1.title,t1.content,t1.create_time,t1.top_time,t2.user_name AS ref_name FROM jyq_case t1 LEFT JOIN jyq_admin t2 ON t1.ref_id = t2.id
				<where>
					t1.top_time IS NULL AND t1.is_draft = 0
					<if test="categoryId != null and categoryId != ''">
						AND t1.category_id = #{categoryId}
					</if>
					<if test="companyId != null and companyId != ''">
						AND t1.company_id = #{companyId}
					</if>
				</where>
				ORDER BY t1.create_time)t2
	</select>

	<select id="queryDraft" resultType="CaseInfoVo">
		SELECT t1.id,t1.title,t1.create_time FROM jyq_case t1
		<where>
			t1.is_draft = 1
			<if test="companyId != null and companyId != ''">
				AND t1.company_id = #{companyId}
			</if>
		</where>
		ORDER BY t1.create_time DESC
	</select>
	
	<!-- 根据ID查询案例详情 -->
	<select id="queryCaseById" resultType="CaseInfoVo">
		SELECT t1.id,t1.title,t1.category_id,t1.type,t1.content FROM jyq_case t1 WHERE t1.id = #{id}
	</select>
	
	<update id="updateTop">
		UPDATE jyq_case SET top_time = NOW() WHERE id = #{id}
	</update>
	
	<update id="updateRef">
		UPDATE jyq_case SET ref_id = #{userId} WHERE id = #{id}
	</update>
</mapper>
